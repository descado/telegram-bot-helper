apiVersion: 1
groups:
  - name: Service Alerts Group
    folder: Service Alerts
    interval: 1m
    rules:
      - uid: p99_latency_alert_rule
        title: Время ответа p99 больше 500ms
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus-ds
            model:
              expr: 'histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="telegram-analytics-app", route!~"/metrics|/health|unknown_route"}[5m])) by (le, route))'
          - refId: C
            datasourceUid: __expr__
            model:
              type: classic_conditions
              conditions:
                - type: query
                  params: [A, last(), IS_ABOVE, 0.5]
        noDataState: OK
        execErrState: OK
        for: 0m
        annotations:
          summary: 'Высокая задержка на ручке {{ $labels.route }}'
          description: 'P99 latency для {{ $labels.route }} составило {{ $values.A }}с.'

      - uid: db_rps_alert_rule
        title: Высокий RPS в базе данных
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus-ds
            model:
              expr: 'sum(rate(mongodb_ss_opcounters[1m]))'
          - refId: C
            datasourceUid: __expr__
            model:
              type: classic_conditions
              conditions:
                - type: query
                  params: [A, last(), IS_ABOVE, 100]
        noDataState: OK
        execErrState: OK
        for: 0m
        annotations:
          summary: 'Критически высокая нагрузка на базу данных!'
          description: 'Суммарный RPS в БД достиг {{ $values.A }}, превысив порог в 100.'